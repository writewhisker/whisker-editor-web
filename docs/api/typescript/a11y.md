# @writewhisker/a11y API Reference

WCAG 2.1 compliant accessibility features for interactive fiction including ARIA management, contrast checking, focus management, keyboard navigation, motion preferences, and screen reader support.

## Installation

```bash
pnpm add @writewhisker/a11y
```

## Quick Start

```typescript
import { createA11ySystem } from '@writewhisker/a11y';

// Create complete accessibility system
const {
  ariaManager,
  contrastChecker,
  focusManager,
  keyboardNavigator,
  motionPreference,
  screenReaderAdapter,
} = createA11ySystem();

// Generate ARIA attributes for a passage
const attrs = ariaManager.getPassageAttributes({
  id: 'chapter-1',
  title: 'Chapter 1',
  content: 'The adventure begins...',
});

// Check color contrast
const result = contrastChecker.validate('#333333', '#ffffff');
console.log(`Contrast ratio: ${result.ratio}`);
console.log(`WCAG AA: ${result.passesAA}`);

// Announce to screen readers
screenReaderAdapter.announce('You have entered Chapter 1', 'polite');
```

---

## ARIA Manager

Generates appropriate ARIA attributes for story elements.

### Creating an ARIA Manager

```typescript
import { AriaManager } from '@writewhisker/a11y';

const ariaManager = AriaManager.create();
```

### Passage Attributes

```typescript
// Get ARIA attributes for a passage
const attrs = ariaManager.getPassageAttributes({
  id: 'chapter-1',
  title: 'Chapter 1',
  content: 'The story begins...',
});

console.log(attrs);
// {
//   role: 'article',
//   'aria-label': 'Chapter 1',
//   'aria-describedby': 'passage-chapter-1-desc',
// }

// Apply to element
const passageEl = document.getElementById('passage');
Object.entries(attrs).forEach(([key, value]) => {
  passageEl.setAttribute(key, value);
});
```

### Choice Attributes

```typescript
// Get ARIA attributes for choices
const choices = [
  { id: 'c1', text: 'Go left' },
  { id: 'c2', text: 'Go right' },
  { id: 'c3', text: 'Wait' },
];

const choiceAttrs = ariaManager.getChoiceAttributes(choices[0], {
  index: 0,
  total: 3,
  selected: false,
});

console.log(choiceAttrs);
// {
//   role: 'option',
//   'aria-posinset': '1',
//   'aria-setsize': '3',
//   'aria-selected': 'false',
// }

// For the choice list container
const listAttrs = ariaManager.getChoiceListAttributes(choices);
// { role: 'listbox', 'aria-label': '3 choices available' }
```

### Dialog Attributes

```typescript
// Modal dialog (save/load, settings)
const dialogAttrs = ariaManager.getDialogAttributes({
  title: 'Save Game',
  isModal: true,
});

// {
//   role: 'dialog',
//   'aria-modal': 'true',
//   'aria-labelledby': 'dialog-title',
// }
```

### Navigation Attributes

```typescript
// Navigation landmark
const navAttrs = ariaManager.getNavigationAttributes({
  label: 'Story navigation',
});

// { role: 'navigation', 'aria-label': 'Story navigation' }
```

---

## Contrast Checker

WCAG 2.1 color contrast validation.

### Creating a Contrast Checker

```typescript
import { ContrastChecker } from '@writewhisker/a11y';

const checker = ContrastChecker.create();
```

### Checking Contrast

```typescript
// Validate contrast ratio
const result = checker.validate('#333333', '#ffffff');

console.log(result);
// {
//   ratio: 12.63,
//   passesAA: true,
//   passesAAA: true,
//   passesAALarge: true,
//   passesAAALarge: true,
// }

// Check specific level
const meetsAA = checker.meetsLevel('#666666', '#ffffff', 'AA');
const meetsAAA = checker.meetsLevel('#666666', '#ffffff', 'AAA');
```

### WCAG Requirements

| Level | Normal Text | Large Text |
|-------|-------------|------------|
| AA | 4.5:1 | 3:1 |
| AAA | 7:1 | 4.5:1 |

Large text: 18pt+ or 14pt+ bold

### Color Parsing

```typescript
// Supports multiple color formats
checker.validate('#fff', '#000');           // Hex short
checker.validate('#ffffff', '#000000');     // Hex
checker.validate('rgb(255,255,255)', 'rgb(0,0,0)');  // RGB
checker.validate('rgba(255,255,255,1)', 'rgba(0,0,0,1)'); // RGBA
```

### Contrast Suggestions

```typescript
// Get suggestions for fixing low contrast
const suggestions = checker.suggestFix('#888888', '#aaaaaa');

console.log(suggestions);
// {
//   adjustForeground: '#4a4a4a',  // Darker foreground
//   adjustBackground: '#ffffff',  // Lighter background
// }
```

### Batch Validation

```typescript
// Check multiple color pairs
const pairs = [
  { foreground: '#333', background: '#fff' },
  { foreground: '#666', background: '#eee' },
  { foreground: '#999', background: '#ccc' },
];

const results = checker.validateAll(pairs);
// Returns array of validation results
```

---

## Focus Manager

Manage keyboard focus for accessible navigation.

### Creating a Focus Manager

```typescript
import { FocusManager } from '@writewhisker/a11y';

const focusManager = FocusManager.create();
```

### Focus Control

```typescript
// Move focus to element
focusManager.focusElement(document.getElementById('main-content'));

// Focus first focusable element in container
focusManager.focusFirst(document.getElementById('choices'));

// Focus last focusable element
focusManager.focusLast(document.getElementById('choices'));
```

### Focus Trapping

Trap focus within a modal or dialog:

```typescript
// Start trapping focus in dialog
const dialog = document.getElementById('save-dialog');
focusManager.trapFocus(dialog);

// User can only tab between elements inside dialog

// Release trap when dialog closes
focusManager.releaseTrap();
```

### Focus History

```typescript
// Save current focus (before opening modal)
focusManager.saveFocus();

// Open modal, do work...

// Restore focus when modal closes
focusManager.restoreFocus();
```

### Focus Visibility

```typescript
// Add focus ring styles
const css = focusManager.getFocusStyles();
// Returns CSS for :focus-visible styling

// Check if element is focusable
const canFocus = focusManager.isFocusable(element);
```

### Getting Focusable Elements

```typescript
// Get all focusable elements in container
const focusables = focusManager.getFocusableElements(container);

// Get first/last focusable
const first = focusManager.getFirstFocusable(container);
const last = focusManager.getLastFocusable(container);
```

---

## Keyboard Navigator

Keyboard navigation for choices and UI.

### Creating a Keyboard Navigator

```typescript
import { KeyboardNavigator } from '@writewhisker/a11y';

const navigator = KeyboardNavigator.create({
  focusManager, // Optional: inject FocusManager
});
```

### Choice Navigation

```typescript
// Handle keyboard events on choice list
const choiceList = document.getElementById('choices');

navigator.attachToElement(choiceList, {
  onSelect: (index) => {
    console.log(`Selected choice ${index}`);
    makeChoice(index);
  },
  onCancel: () => {
    console.log('Cancelled');
  },
});

// Arrow keys navigate, Enter/Space selects, Escape cancels
```

### Custom Key Handlers

```typescript
// Register custom keyboard handler
navigator.registerHandler('KeyH', {
  handler: () => showHelp(),
  description: 'Show help',
  preventDefault: true,
});

navigator.registerHandler('KeyS', {
  handler: () => saveGame(),
  description: 'Quick save',
  modifiers: { ctrl: true },
  preventDefault: true,
});

// List registered handlers
const handlers = navigator.getHandlers();
```

### Navigation Modes

```typescript
// Set navigation mode
navigator.setMode('choices');  // Choice selection
navigator.setMode('reading');  // Reading passage
navigator.setMode('dialog');   // In dialog

// Get current mode
const mode = navigator.getMode();
```

### Keyboard Shortcuts Help

```typescript
// Get keyboard shortcuts for help display
const shortcuts = navigator.getShortcutList();
// [
//   { key: 'ArrowUp', description: 'Previous choice' },
//   { key: 'ArrowDown', description: 'Next choice' },
//   { key: 'Enter', description: 'Select choice' },
//   { key: 'Escape', description: 'Cancel' },
// ]
```

---

## Motion Preference

Respect user's reduced motion preferences.

### Creating a Motion Preference Manager

```typescript
import { MotionPreference } from '@writewhisker/a11y';

const motionPref = MotionPreference.create();
```

### Checking Motion Preference

```typescript
// Check if reduced motion is preferred
const prefersReduced = motionPref.prefersReducedMotion();

if (prefersReduced) {
  // Use instant transitions
  element.style.transition = 'none';
} else {
  // Use animations
  element.style.transition = 'opacity 0.3s ease';
}
```

### Getting Animation Duration

```typescript
// Get appropriate animation duration
const duration = motionPref.getAnimationDuration(300);
// Returns 300 if motion OK, 0 if reduced motion preferred

// Apply to animations
element.style.animationDuration = `${duration}ms`;
```

### Motion Sources

```typescript
// Get preference source
const source = motionPref.getSource();
// 'system' | 'user' | 'default'

// Force user override
motionPref.setUserPreference('reduce'); // Force reduced
motionPref.setUserPreference('normal'); // Force normal
motionPref.setUserPreference('system'); // Follow system
```

### Listening for Changes

```typescript
// Listen for preference changes
motionPref.onChange((prefersReduced) => {
  if (prefersReduced) {
    disableAnimations();
  } else {
    enableAnimations();
  }
});
```

### CSS Helpers

```typescript
// Get CSS for respecting motion preferences
const css = motionPref.getCss();
// @media (prefers-reduced-motion: reduce) {
//   *, *::before, *::after {
//     animation-duration: 0.01ms !important;
//     transition-duration: 0.01ms !important;
//   }
// }
```

---

## Screen Reader Adapter

Communicate with screen readers via live regions.

### Creating a Screen Reader Adapter

```typescript
import { ScreenReaderAdapter } from '@writewhisker/a11y';

const screenReader = ScreenReaderAdapter.create();
```

### Announcements

```typescript
// Polite announcement (waits for pause in speech)
screenReader.announce('You have entered Chapter 2', 'polite');

// Assertive announcement (interrupts current speech)
screenReader.announce('Game saved successfully', 'assertive');

// Status messages
screenReader.announceStatus('Loading...');
screenReader.announceStatus('Load complete');
```

### Live Region Management

```typescript
// Create live regions (usually done once on init)
screenReader.createLiveRegion('story-updates', {
  priority: 'polite',
  atomic: true,
});

screenReader.createLiveRegion('alerts', {
  priority: 'assertive',
  atomic: true,
});

// Announce to specific region
screenReader.announceToRegion('story-updates', 'The door creaks open...');
screenReader.announceToRegion('alerts', 'Warning: Low health!');
```

### Passage Announcements

```typescript
// Announce passage change
screenReader.announcePassage({
  title: 'The Dark Forest',
  content: 'You find yourself in a dark forest...',
  choiceCount: 3,
});

// "The Dark Forest. You find yourself in a dark forest... 3 choices available."
```

### Debouncing

```typescript
// Multiple rapid calls are debounced
screenReader.announce('Loading 1%');
screenReader.announce('Loading 50%');
screenReader.announce('Loading 100%'); // Only this is announced
```

### Getting Live Region HTML

```typescript
// Get HTML for live regions
const html = screenReader.getLiveRegionHtml();
// Returns HTML string for live region containers
```

---

## Utility Functions

Common accessibility utilities.

### ID Generation

```typescript
import { generateId } from '@writewhisker/a11y';

const id = generateId('passage');
// 'passage-a1b2c3d4'
```

### HTML Escaping

```typescript
import { escapeHtml, stripHtml } from '@writewhisker/a11y';

const escaped = escapeHtml('<script>alert("xss")</script>');
// '&lt;script&gt;alert("xss")&lt;/script&gt;'

const stripped = stripHtml('<p>Hello <strong>world</strong></p>');
// 'Hello world'
```

### CSS Helpers

```typescript
import {
  getSrOnlyCss,
  getFocusVisibleCss,
  getSkipLinkCss,
  getAllA11yCss,
} from '@writewhisker/a11y';

// Screen reader only (visually hidden)
const srOnlyCss = getSrOnlyCss();

// Focus visible styles
const focusCss = getFocusVisibleCss();

// Skip link styles
const skipCss = getSkipLinkCss();

// All accessibility CSS combined
const allCss = getAllA11yCss();
```

### Text Processing

```typescript
import {
  normalizeWhitespace,
  truncateForAnnouncement,
  isDecorativeText,
} from '@writewhisker/a11y';

// Normalize whitespace
const normalized = normalizeWhitespace('  Hello   world  ');
// 'Hello world'

// Truncate for screen reader
const truncated = truncateForAnnouncement(longText, 200);
// Truncates at word boundary

// Check if decorative
const decorative = isDecorativeText('***');
// true
```

### Description Helpers

```typescript
import {
  createDescription,
  createHiddenDescription,
  isDescriptiveLinkText,
} from '@writewhisker/a11y';

// Create accessible description
const desc = createDescription('Explore the cave to find treasure');

// Create hidden description element
const html = createHiddenDescription('desc-1', 'Additional context...');
// <span id="desc-1" class="sr-only">Additional context...</span>

// Check link text quality
const isDescriptive = isDescriptiveLinkText('Click here'); // false
const isDescriptive2 = isDescriptiveLinkText('View chapter 2'); // true
```

### Accessibility Metadata

```typescript
import { getAccessibilityMetadata } from '@writewhisker/a11y';

const metadata = getAccessibilityMetadata(element);
// {
//   role: 'button',
//   label: 'Save game',
//   description: 'Save your current progress',
//   state: { pressed: false, expanded: false },
// }
```

---

## Complete Example

```typescript
import { createA11ySystem, getAllA11yCss } from '@writewhisker/a11y';

// Create system
const {
  ariaManager,
  contrastChecker,
  focusManager,
  keyboardNavigator,
  motionPreference,
  screenReaderAdapter,
} = createA11ySystem();

// Inject CSS
const style = document.createElement('style');
style.textContent = getAllA11yCss();
document.head.appendChild(style);

// Set up live regions
screenReaderAdapter.createLiveRegion('story', { priority: 'polite' });

// Render passage accessibly
function renderPassage(passage) {
  const passageEl = document.getElementById('passage');

  // Apply ARIA attributes
  const attrs = ariaManager.getPassageAttributes(passage);
  Object.entries(attrs).forEach(([key, value]) => {
    passageEl.setAttribute(key, value);
  });

  // Set content
  passageEl.innerHTML = passage.content;

  // Announce to screen readers
  screenReaderAdapter.announcePassage(passage);

  // Focus passage (with animation if allowed)
  const duration = motionPreference.getAnimationDuration(300);
  if (duration > 0) {
    passageEl.style.opacity = '0';
    setTimeout(() => {
      passageEl.style.transition = `opacity ${duration}ms`;
      passageEl.style.opacity = '1';
    }, 50);
  }

  focusManager.focusElement(passageEl);
}

// Render choices accessibly
function renderChoices(choices) {
  const listEl = document.getElementById('choices');

  // Apply list attributes
  const listAttrs = ariaManager.getChoiceListAttributes(choices);
  Object.entries(listAttrs).forEach(([key, value]) => {
    listEl.setAttribute(key, value);
  });

  // Render each choice
  listEl.innerHTML = choices.map((choice, i) => {
    const attrs = ariaManager.getChoiceAttributes(choice, {
      index: i,
      total: choices.length,
      selected: false,
    });
    const attrsStr = Object.entries(attrs)
      .map(([k, v]) => `${k}="${v}"`)
      .join(' ');
    return `<button ${attrsStr}>${choice.text}</button>`;
  }).join('');

  // Set up keyboard navigation
  keyboardNavigator.attachToElement(listEl, {
    onSelect: (index) => selectChoice(choices[index]),
  });

  // Focus first choice
  focusManager.focusFirst(listEl);
}

// Open dialog accessibly
function openDialog(dialog) {
  const dialogEl = document.getElementById('dialog');

  // Apply ARIA
  const attrs = ariaManager.getDialogAttributes({
    title: dialog.title,
    isModal: true,
  });
  Object.entries(attrs).forEach(([key, value]) => {
    dialogEl.setAttribute(key, value);
  });

  // Save focus and trap
  focusManager.saveFocus();
  focusManager.trapFocus(dialogEl);

  // Announce
  screenReaderAdapter.announce(`${dialog.title} dialog opened`, 'assertive');
}

function closeDialog() {
  focusManager.releaseTrap();
  focusManager.restoreFocus();
  screenReaderAdapter.announce('Dialog closed', 'polite');
}
```

---

## TypeScript Types

```typescript
import type {
  AriaRole,
  AriaAttribute,
  AriaAttributes,
  WCAGLevel,
  ContrastValidationResult,
  ColorPair,
  FocusOptions,
  FocusableElement,
  KeyboardHandler,
  NavigationMode,
  LiveRegionPriority,
  MotionPreferenceSource,
  MotionPreferenceData,
  AccessibilityMetadata,
  Passage,
  Choice,
  EventBus,
  Logger,
  A11yDependencies,
} from '@writewhisker/a11y';
```

---

## WCAG Compliance

This module helps achieve:

| Criterion | Level | Feature |
|-----------|-------|---------|
| 1.3.1 Info and Relationships | A | ARIA roles and labels |
| 1.4.3 Contrast (Minimum) | AA | Contrast checker |
| 1.4.6 Contrast (Enhanced) | AAA | Contrast checker |
| 2.1.1 Keyboard | A | Keyboard navigator |
| 2.1.2 No Keyboard Trap | A | Focus manager |
| 2.4.3 Focus Order | A | Focus manager |
| 2.4.7 Focus Visible | AA | Focus styles |
| 2.3.3 Animation from Interactions | AAA | Motion preference |
| 4.1.2 Name, Role, Value | A | ARIA manager |
| 4.1.3 Status Messages | AA | Screen reader adapter |
