# @writewhisker/i18n API Reference

Complete internationalization support for Whisker stories including translations, pluralization, locale detection, and bidirectional text.

## Installation

```bash
pnpm add @writewhisker/i18n
```

## Quick Start

```typescript
import { createI18nSystem } from '@writewhisker/i18n';

// Create a complete i18n system
const { i18n, locale, stringTable, pluralization } = createI18nSystem({
  defaultLocale: 'en',
  fallbackLocale: 'en',
});

// Load translations
stringTable.addTranslations('en', {
  greeting: 'Hello, {name}!',
  items: '{count, plural, one {# item} other {# items}}',
});

stringTable.addTranslations('es', {
  greeting: '¡Hola, {name}!',
  items: '{count, plural, one {# artículo} other {# artículos}}',
});

// Use translations
const greeting = i18n.t('greeting', { name: 'World' });
console.log(greeting); // "Hello, World!"

// Change locale
i18n.setLocale('es');
console.log(i18n.t('greeting', { name: 'Mundo' })); // "¡Hola, Mundo!"
```

---

## I18n Class

The main entry point for internationalization.

### Creating an Instance

```typescript
import { I18n, createI18nSystem } from '@writewhisker/i18n';

// Using factory function (recommended)
const { i18n } = createI18nSystem({
  defaultLocale: 'en',
  fallbackLocale: 'en',
  autoDetect: true,
});

// Using class directly
const i18n = I18n.create({
  defaultLocale: 'en-US',
  fallbackLocale: 'en',
  autoDetect: true,
});
```

### Configuration Options

```typescript
interface I18nConfig {
  defaultLocale?: string;     // Default locale (e.g., 'en', 'en-US')
  fallbackLocale?: string;    // Fallback when translation missing
  autoDetect?: boolean;       // Auto-detect browser locale
}
```

### Core Methods

#### t(key, vars?) - Translate

```typescript
// Simple translation
const text = i18n.t('welcome_message');

// With variable interpolation
const greeting = i18n.t('greeting', { name: 'Alice' });

// With pluralization
const items = i18n.t('item_count', { count: 5 });
```

#### setLocale(locale) - Change Locale

```typescript
i18n.setLocale('fr');
i18n.setLocale('zh-Hans'); // Chinese Simplified
i18n.setLocale('ar');      // Arabic (RTL)
```

#### getLocale() - Get Current Locale

```typescript
const current = i18n.getLocale();
console.log(current); // 'en-US'
```

#### getDirection() - Get Text Direction

```typescript
const dir = i18n.getDirection();
console.log(dir); // 'ltr' or 'rtl'
```

#### hasTranslation(key) - Check Translation Exists

```typescript
if (i18n.hasTranslation('new_feature')) {
  console.log(i18n.t('new_feature'));
} else {
  console.log('Feature description unavailable');
}
```

### Events

```typescript
import { I18N_EVENTS } from '@writewhisker/i18n';

i18n.on(I18N_EVENTS.LOCALE_CHANGED, (newLocale, oldLocale) => {
  console.log(`Locale changed from ${oldLocale} to ${newLocale}`);
  // Update UI direction, reload content, etc.
});

i18n.on(I18N_EVENTS.TRANSLATIONS_LOADED, (locale) => {
  console.log(`Translations loaded for ${locale}`);
});
```

### Accessing Sub-systems

```typescript
const locale = i18n.getLocaleManager();       // Locale management
const stringTable = i18n.getStringTable();    // String storage
const pluralization = i18n.getPluralization(); // Plural rules
```

---

## StringTable Class

Manages translation strings with hierarchical keys and variable interpolation.

### Creating a StringTable

```typescript
import { StringTable, createStringTable } from '@writewhisker/i18n';

const stringTable = createStringTable({
  defaultLocale: 'en',
  fallbackLocale: 'en',
});
```

### Adding Translations

```typescript
// Add flat translations
stringTable.addTranslations('en', {
  hello: 'Hello',
  goodbye: 'Goodbye',
});

// Add nested translations (using dot notation)
stringTable.addTranslations('en', {
  'menu.file': 'File',
  'menu.edit': 'Edit',
  'menu.view': 'View',
});

// Add bulk translations
stringTable.addTranslations('de', {
  hello: 'Hallo',
  goodbye: 'Auf Wiedersehen',
  'menu.file': 'Datei',
  'menu.edit': 'Bearbeiten',
});
```

### Variable Interpolation

```typescript
stringTable.addTranslations('en', {
  greeting: 'Hello, {name}!',
  order: 'Order #{orderId} contains {count} items',
});

// Use variables
const text = stringTable.get('greeting', 'en', { name: 'Alice' });
// "Hello, Alice!"

const order = stringTable.get('order', 'en', { orderId: '12345', count: 3 });
// "Order #12345 contains 3 items"
```

### Pluralization in Strings

```typescript
stringTable.addTranslations('en', {
  items: '{count, plural, zero {No items} one {One item} other {# items}}',
  messages: '{count, plural, =0 {No messages} =1 {One message} other {# messages}}',
});

console.log(stringTable.get('items', 'en', { count: 0 }));  // "No items"
console.log(stringTable.get('items', 'en', { count: 1 }));  // "One item"
console.log(stringTable.get('items', 'en', { count: 5 }));  // "5 items"
```

### Key Lookup

```typescript
// Check if key exists
const exists = stringTable.has('greeting', 'en');

// Get with fallback
const text = stringTable.getOrDefault('missing_key', 'en', 'Default text');

// Get all keys
const keys = stringTable.getKeys('en');

// Get all translations for locale
const translations = stringTable.getAll('en');
```

---

## Locale Class

Manages locale detection, switching, and persistence.

### Creating a Locale Manager

```typescript
import {
  Locale,
  createLocale,
  BrowserPlatformAdapter,
  LocalStorageAdapter
} from '@writewhisker/i18n';

// Simple in-memory locale
const locale = createLocale({
  defaultLocale: 'en',
  autoDetect: true,
});

// With browser detection and localStorage persistence
const locale = Locale.create({
  defaultLocale: 'en',
  autoDetect: true,
  platform: new BrowserPlatformAdapter(),
  storage: new LocalStorageAdapter(),
});
```

### Locale Operations

```typescript
// Get current locale
const current = locale.getCurrent();

// Set locale
locale.set('fr-FR');

// Get language code only
const lang = locale.getLanguage(); // 'fr'

// Get region code
const region = locale.getRegion(); // 'FR'

// Check if RTL
const isRTL = locale.isRTL();
```

### Locale Detection

```typescript
import { findBestMatch } from '@writewhisker/i18n';

// Find best match from available locales
const supported = ['en', 'es', 'fr', 'de'];
const userPreference = 'es-MX'; // Mexican Spanish

const best = findBestMatch(userPreference, supported);
console.log(best); // 'es' (Spanish)
```

### Locale Utilities

```typescript
import {
  parseLocale,
  buildLocale,
  normalizeLocale,
  getLanguage,
  getRegion,
  getScript,
  localesMatch,
  getNativeName,
  getAllNativeNames,
} from '@writewhisker/i18n';

// Parse locale string
const components = parseLocale('zh-Hans-CN');
// { language: 'zh', script: 'Hans', region: 'CN' }

// Build locale string
const locale = buildLocale({ language: 'pt', region: 'BR' });
// 'pt-BR'

// Normalize locale
const normalized = normalizeLocale('EN_us');
// 'en-US'

// Get native names
const name = getNativeName('de');
// 'Deutsch'

const allNames = getAllNativeNames();
// { en: 'English', de: 'Deutsch', fr: 'Français', ... }
```

---

## Pluralization

CLDR-compliant pluralization rules for multiple languages.

### Basic Usage

```typescript
import {
  Pluralization,
  createPluralization,
  getCategory,
  getCategoriesForLanguage
} from '@writewhisker/i18n';

const pluralization = createPluralization();

// Get plural category for a number
const category = pluralization.getCategory(1, 'en');    // 'one'
const category2 = pluralization.getCategory(5, 'en');   // 'other'
const category3 = pluralization.getCategory(0, 'ar');   // 'zero'
const category4 = pluralization.getCategory(2, 'ar');   // 'two'
```

### Plural Categories

```typescript
type PluralCategory = 'zero' | 'one' | 'two' | 'few' | 'many' | 'other';
```

Different languages use different categories:

| Language | Categories Used |
|----------|-----------------|
| English  | one, other |
| Arabic   | zero, one, two, few, many, other |
| Russian  | one, few, many, other |
| Japanese | other (no plural distinctions) |
| Polish   | one, few, many, other |

### Getting Categories for Language

```typescript
const categories = getCategoriesForLanguage('ar');
// ['zero', 'one', 'two', 'few', 'many', 'other']

const categories2 = getCategoriesForLanguage('en');
// ['one', 'other']
```

### Custom Plural Rules

```typescript
const pluralization = createPluralization();

// Register custom rule for a language variant
pluralization.registerRule('en-gaming', (n: number) => {
  if (n === 0) return 'zero';
  if (n === 1) return 'one';
  return 'other';
});
```

---

## Bidirectional Text (BiDi)

Support for right-to-left (RTL) languages like Arabic, Hebrew, and Persian.

### Direction Detection

```typescript
import {
  getDirection,
  isRTL,
  isLTR,
  isRTLLanguage,
  getRTLLanguages,
  detectFromText,
} from '@writewhisker/i18n';

// Get direction for locale
const dir = getDirection('ar');     // 'rtl'
const dir2 = getDirection('en-US'); // 'ltr'

// Check if RTL
console.log(isRTL('he'));  // true (Hebrew)
console.log(isRTL('en'));  // false

// Check if language is RTL
console.log(isRTLLanguage('ar')); // true
console.log(isRTLLanguage('fa')); // true (Farsi/Persian)

// Get all RTL languages
const rtlLanguages = getRTLLanguages();
// ['ar', 'he', 'fa', 'ur', 'yi', ...]

// Detect direction from text content
const detected = detectFromText('مرحبا'); // 'rtl'
const detected2 = detectFromText('Hello'); // 'ltr'
```

### Text Wrapping and Isolation

```typescript
import {
  wrap,
  isolate,
  mark,
  BIDI_MARKS,
} from '@writewhisker/i18n';

// Wrap text with direction marks
const wrapped = wrap('مرحبا', 'rtl');
// Contains RLM (Right-to-Left Mark) characters

// Isolate text (for mixed content)
const isolated = isolate('username123', 'ltr');
// Prevents RTL context from affecting LTR text

// Add explicit direction mark
const marked = mark('text', 'ltr');

// BiDi marks constants
console.log(BIDI_MARKS.LRM); // Left-to-Right Mark
console.log(BIDI_MARKS.RLM); // Right-to-Left Mark
console.log(BIDI_MARKS.LRE); // Left-to-Right Embedding
console.log(BIDI_MARKS.RLE); // Right-to-Left Embedding
```

### HTML Helpers

```typescript
import {
  htmlDir,
  htmlSpan,
  htmlBdi,
  cssDirection,
  cssTextAlign,
} from '@writewhisker/i18n';

// Get HTML dir attribute
const dirAttr = htmlDir('ar');
// 'dir="rtl"'

// Wrap in span with direction
const span = htmlSpan('مرحبا', 'rtl');
// '<span dir="rtl">مرحبا</span>'

// Use BDI element (bidirectional isolate)
const bdi = htmlBdi('username');
// '<bdi>username</bdi>'

// Get CSS properties
const dirCss = cssDirection('rtl');
// 'direction: rtl;'

const alignCss = cssTextAlign('rtl');
// 'text-align: right;'
```

### Stripping Marks

```typescript
import { stripMarks, containsRTL } from '@writewhisker/i18n';

// Remove all BiDi marks
const clean = stripMarks(textWithMarks);

// Check if text contains RTL characters
const hasRTL = containsRTL('Hello مرحبا World');
// true
```

---

## Factory Functions

Convenience functions for creating standalone instances.

```typescript
import {
  createI18nSystem,
  createStringTable,
  createLocale,
  createPluralization,
} from '@writewhisker/i18n';

// Complete system
const { i18n, locale, stringTable, pluralization } = createI18nSystem({
  defaultLocale: 'en',
  autoDetect: true,
});

// Standalone components
const stringTable = createStringTable({ defaultLocale: 'en' });
const locale = createLocale({ defaultLocale: 'en', autoDetect: true });
const pluralization = createPluralization();
```

---

## Storage Adapters

Persist locale preferences across sessions.

```typescript
import {
  LocalStorageAdapter,
  MemoryStorageAdapter,
} from '@writewhisker/i18n';

// localStorage (browser)
const browserStorage = new LocalStorageAdapter();

// In-memory (testing/SSR)
const memoryStorage = new MemoryStorageAdapter();

// Use with Locale
const locale = Locale.create({
  defaultLocale: 'en',
  storage: browserStorage,
});
```

---

## Integration with Stories

### Localizing Story Content

```typescript
import { createI18nSystem } from '@writewhisker/i18n';
import { StoryPlayer } from '@writewhisker/story-player';

const { i18n } = createI18nSystem();

// Load translations for story
i18n.loadTranslations('en', {
  'story.greeting': 'Welcome, brave adventurer!',
  'story.forest.enter': 'You enter the dark forest...',
  'choice.explore': 'Explore deeper',
  'choice.return': 'Return to safety',
});

i18n.loadTranslations('es', {
  'story.greeting': '¡Bienvenido, valiente aventurero!',
  'story.forest.enter': 'Entras en el bosque oscuro...',
  'choice.explore': 'Explorar más',
  'choice.return': 'Volver a la seguridad',
});

// Use in story rendering
function renderPassage(passage) {
  const content = i18n.t(`story.${passage.id}`);
  const choices = passage.choices.map(c => ({
    ...c,
    text: i18n.t(`choice.${c.id}`),
  }));
  return { content, choices };
}
```

### RTL Story Support

```typescript
// Apply RTL styling when needed
if (i18n.getDirection() === 'rtl') {
  document.documentElement.dir = 'rtl';
  document.documentElement.lang = i18n.getLocale();
}

// Listen for locale changes
i18n.on('locale:changed', () => {
  document.documentElement.dir = i18n.getDirection();
  document.documentElement.lang = i18n.getLocale();
});
```

---

## TypeScript Types

```typescript
import type {
  I18nConfig,
  TranslationVars,
  TranslationData,
  TextDirection,
  PluralCategory,
  LocaleComponents,
  StringTableConfig,
} from '@writewhisker/i18n';
```

---

## Best Practices

### 1. Use Hierarchical Keys

```typescript
// Good - organized and searchable
'menu.file.new'
'menu.file.open'
'dialog.confirm.title'
'dialog.confirm.message'

// Avoid - flat and hard to maintain
'menu_file_new'
'confirmDialogTitle'
```

### 2. Always Provide Fallbacks

```typescript
const { i18n } = createI18nSystem({
  defaultLocale: 'en',
  fallbackLocale: 'en', // Always set fallback
});
```

### 3. Load Translations Lazily

```typescript
async function loadLocale(locale: string) {
  const translations = await import(`./locales/${locale}.json`);
  stringTable.addTranslations(locale, translations);
}

// Load on demand
i18n.on('locale:changed', async (newLocale) => {
  if (!stringTable.hasLocale(newLocale)) {
    await loadLocale(newLocale);
  }
});
```

### 4. Handle RTL Layout

```css
/* Use logical properties */
.container {
  margin-inline-start: 1rem; /* Not margin-left */
  padding-inline-end: 1rem;  /* Not padding-right */
}
```
